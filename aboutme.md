# نبذة شاملة عن النظام (About Me)

هذا المستند يقدّم شرحًا تفصيليًا لكل ميزة وصفحة ووظيفة في مشروع إدارة المزارع والموارد البشرية والمساكن والمخزون. الهدف هو أن يكون مرجعًا عمليًا يغطي أصغر التفاصيل مع أمثلة واضحة.

## 1) نظرة عامة على المشروع

- نظام ويب لإدارة مزارع (Fermes) متعددة، العمال (Workers)، الغرف (Rooms)، التحويلات (Transfers)، والمخزون (Stock)، مع لوحات إحصائية وتقارير PDF/Excel، وصلاحيات مختلفة للمستخدمين.
- الواجهة مبنية بـ React + TypeScript + Vite مع TailwindCSS ومكوّنات UI جاهزة (shadcn/ui). الرسوم البيانية عبر Recharts. التقارير عبر jsPDF وjspdf-autotable وhtml2canvas. التصدير إلى Excel عبر xlsx.
- قاعدة البيانات: Firebase Firestore والمصادقة عبر Firebase Auth.
- يوجد طبقة "hooks" و"contexts" لإدارة البيانات والحالة، وطبقة "utils" لأدوات مثل المزامنة وحماية الشبكة.

## 2) الصلاحيات والأدوار

مصدر الحقيقة: client/contexts/AuthContext.tsx و shared/types.ts
- الأدوار: superadmin, admin, user.
- isSuperAdmin: تحكم شامل على كل المزارع والصفحات الإدارية.
- isAdmin: إدارة مزرعة محددة (أو كل المزارع إن مُنح ذلك في حسابه).
- isUser: صلاحيات تشغيلية (عرض/إضافة ضمن حدود مزرعته).
- hasAllFarmsAccess: true للمُشرِف العام أو عندما يكون fermeId == 'all'.

أمثلة:
- مستخدم (user) يرى فقط عمال وغرف مزرعته ويصدر تقاريرها.
- مشرف (admin) يدير الغرف/العمال والعمليات لمزرعته.
- مشرف عام (superadmin) يدير كل المزارع، المستخدمين، المشرفين، وإعدادات الأمان.

## 3) نماذج البيانات (shared/types.ts)

- Ferme: { id, nom, totalChambres, totalOuvriers, admins[] }
- Worker: معلومات العامل (الاسم، CIN، الجنس، العمر، الغرفة، القطاع، التواريخ، الحالة actif/inactif، supervisorId، تاريخ العمل history...)
- Room: { id, numero, fermeId, genre, secteur, capaciteTotale, occupantsActuels, listeOccupants[] }
- Supervisor: { id, nom, telephone, company?, statut, createdAt }
- Stock/StockTransfer/StockAddition: نماذج لإدارة المخزون والتحركات.
- WorkerTransfer: نقل عمال بين المزارع.

هذه النماذج تستخدم مباشرة في الصفحات والجداول والفلاتر والتقارير.

## 4) البنية المعمارية

- client/components: مكوّنات العرض (Cards, Tables, Buttons, Dialogs, Tabs, Popover...).
- client/contexts: مثل AuthContext لإدارة المستخدم والدخول، DataContext/NotificationContext.
- client/hooks: useFirestore (جلب بيانات Firestore)، useSupervisors (يدعم تخزينًا مؤقتًا Offline)، useHybridFirestore، useToast...
- client/pages: الصفحات الأساسية المذكورة أدناه.
- client/utils: أدوات مزامنة الإشغال، فلاتر الشركة، اختبارات، توليد عينات...
- shared/: تعريفات الأنواع TypeScript المشتركة بين الواجهة والخادم/دوال Netlify.
- server/ و netlify/functions/: نقاط نهاية مساعدة/وظائف بدون خادم إن لزم.

## 5) كل الصفحات والميزات

### 5.1 لوحة التحكم (Dashboard.tsx)
- لمحة سريعة عن الأرقام: إجمالي العمال/الغرف، نسبة الإشغال، مؤشرات الأداء.
- روابط سريعة للتنقّل بين الوحدات.
- أمثلة استخدام: الدخول السريع لفهم حالة النظام اليوم.

### 5.2 المزارع (Fermes.tsx)
- شبكة بطاقات لكل مزرعة مع:
  - الاسم والأيقونات.
  - عدد العمال حسب الجنس.
  - نسبة الإشغال (شريط تقدّم + نسبة مئوية).
  - عدد الغرف الشاغرة والممتلئة.
- إجراءات لكل مزرعة: تعديل/حذف (بحسب الصلاحيات).
- مثال: رؤية "FINCA 02" باحتلال 58% و7 عمال و4 غرف.

### 5.3 العمال (Workers.tsx)
- شريط أدوات كامل:
  - استيراد Excel، تصدير Excel، إضافة عامل جديد.
  - بحث لحظي: الاسم، CIN، matricule.
  - فلاتر متقدمة: المزرعة، الجنس، الحالة (actif/inactif)، الشهر/الس��ة، المشرف، الشركة (interime).
- جدول متجاوب قابل للفرز والبحث والتصفية (ResponsiveDataTable):
  - الأعمدة: Matricule، Nom، CIN، Ferme، Contact، Sexe، Âge، Secteur، Superviseur، Date d'entrée، Date de sortie، Statut، Actions.
- أمثلة:
  - تصفية "Toutes les fermes" + "Tous superviseurs" + سنة محددة لإعداد تقرير سنوي.
  - تحديد صفوف ثم تصديرها إلى Excel.

### 5.4 الغرف (Rooms.tsx)
- جدول الغرف مع رقم الغرفة، النوع (hommes/femmes)، السعة، عدد الشاغلين، المزرعة.
- حسابات الإشغال تقرأ من العمال الفعليين.
- مثال: فرز الغرف حسب السعة لاكتشاف الاختناقات.

### 5.5 التحويلات (Transfers.tsx)
- إدارة نقل العمال بين المزارع مع حالات: pending، confirmed، delivered، rejected...
- لكل تحويل: المزرعة المصدر/الوجهة، قائمة العمال، تتبّع المراحل، الملاحظات.
- مثال: تحويل 5 عمال من FINCA 01 إلى FINCA 21 واعتماد الاستلام.

### 5.6 المخزون (Stock.tsx)
- إدارة العناصر (item، الكمية، الوحدة، العتبات، ال��وردين...).
- التحويلات بين المزارع، الإضافات، التنبيهات (انخفاض/زيادة/استلام...)
- مثال: نقل 10 أسرّة من مزرعة إلى أخرى وتتبّع حالة الشحنة.

### 5.7 الإحصائيات (Statistics.tsx)
- فلاتر أعلى الصفحة:
  - اختيار المزرعة: مزرعة واحدة أو "Toutes les fermes".
  - الفترة: 7 أيام/30 يومًا/ربع سنة/سنة أو شهر/سنة محددين أو نطاق مخصّص.
  - الجنس: الكل/ذكور/إناث.
  - خيار مقارنة الفترة السابقة.
- بطاقات KPI حديثة (Ouvriers Actifs، Occupation، Nouveaux Arrivants، Sorties، Rétention...).
- رسوم بيانية تفاعلية (Recharts) لسلاسل يومية (الوصول/المغادرة/نسبة الإشغال).
- جداول تحليلية متقدمة:
  - الديموغرافيا (متوسط العمر، التوزيع العمري والجندري).
  - السكن والإشغال (الغرف الكلي/المشغول/الفارغ، الأماكن المتاحة، الكفاءة).
  - أسباب الخروج مرتبة مع نسبها.
  - تحليل المشرفين: توزيع العمال النشطين لكل مشرف + نسبة مساهمته + أداء (Excellent/Bon/Acceptable/Inactif).
  - إحصاءات الشركات (interime): عدد العمال، المشرفين الفعّالين، وعدد المزارع المغطاة لكل شركة.
- تصدير PDF متقدم:
  - تصميم احترافي بعناوين وألوان، رؤوس وتذييل صفحات، دمج صور للرسوم البيانية عبر html2canvas.
  - نفس البنية للـ "مزرعة واحدة" و"كل المزارع"، الاختلاف فقط في التصفية.
  - كل من جدول "تحليل المشرفين" وجدول "إحصاءات الشركات" موضوعان كلٌ في صفحة منفصلة داخل التقرير (تم تطبيق ذلك).
- تصدير PDF أساسي كبديل في حال حدوث خطأ، مع نفس الجداول الرئيسية.
- تصدير جداول إلى Excel عند الحاجة (مثل مقارنة المزارع).

أمثلة استخدام:
- اختيار "Toutes les fermes" + "السنة الماضية" لإنتاج تقرير أداء سنوي شامل PDF يحتوي: الملخّص التنفيذي، KPIs، الديموغرافيا، الإشغال، أسباب الخروج، صفحة المشرفين، ثم صفحة الشركات." 
- اختيار مزرعة محددة لإصدار تقرير مماثل لك�� محصور بتلك المزرعة فقط.

### 5.8 الإدارة (Admin*)
- AdminDashboard.tsx: لمحة إدارية سريعة.
- AdminUserManagement.tsx: إدارة المستخدمين والأدوار وربطهم بالمزارع أو منح وصول لجميع المزارع.
- AdminSupervisorManagement.tsx: إدارة المشرفين (الاسم، الهاتف، الشركة، الحالة) مع تصدير/استيراد.
- AdminSecurityCenter.tsx: مركز الأمان (سياسات، فحص الإعدادات، أدلة التصحيح).
- AdminSystemTools.tsx / AdminTools.tsx: أدوات صيانة، إصلاحات تلقائية، وظائف مساعدة.
- AdminContentManagement.tsx: إدارة محتوى داخلي إن لزم.
- SuperAdminSetup.tsx: تهيئة أولية للحسابات العليا.

### 5.9 الإعدادات (Settings.tsx)
- إعدادات عامة للمستخدم أو السلوك الافتراضي للتطبيق.

### 5.10 صفحات إضافية
- Index.tsx: الصفحة الرئيسية/التحويل.
- NotFound.tsx: صفحة 404.
- PlaceholderPage.tsx: صفحة مؤقتة.

## 6) الميزات المشتركة في الجداول (ResponsiveDataTable)

- بحث فوري عبر كل الأعمدة المعروضة.
- فرز تصاعدي/تنازلي لكل عمود قابل للفرز.
- تصفية أعمدة محدّدة.
- ترقيم الصفحات، اختيار الصفوف، إجراءات جماعية، وتصدير اختياري.
- عرض متجاوب (موبايل/لوحي/سطح مكتب) مع الحفاظ على تجربة جدول.

مثال:
- في جدول المشرفين: ابحث باسم الشركة أو رقم الهاتف، فرز حسب "Nombre d'ouvriers"، ثم صدّر النتائج.

## 7) التصدير والاستيراد

- Excel عبر xlsx: استيراد/تصدير العمال، وتصدير جداول مقارنة المزارع.
- PDF عبر jsPDF + autotable + html2canvas: تقارير احترافية مقسّمة إلى صفحات، مع رؤوس وتذييلات ونِسَب وألوان.
- أمثلة: تصدير تقرير "Analyse des superviseurs" في صفحة مستقلة، ثم صفحة مستقلة أخرى "Statistiques par interime".

## 8) المزامنة والحماية من أخطاء الشبكة

- utils/circuitBreaker.ts: قاطع دوائر لتقليل محاولات الشبكة عند انقطاع الاتصال.
- hooks/useSupervisors.ts: تحميل من Firestore مع تخزين مؤقت محلي (Cache) لتجربة أفضل دون اتصال.
- OfflineIndicator: ينبه المستخدم عند انقطاع الشبكة.

## 9) الرسوم البيانية والاتجاهات

- تقارير الإشغال اليومية، الوافدين والمغادرين لكل يوم في نطاق الفترة المختارة.
- حسابات المقارنة بالفترة السابقة (٪ تغيير).

## 10) الأمان والخصوصية

- Firebase Auth لإدارة الدخول.
- Firestore Security Rules (راجع firestore.rules وملفات الدليل) لتقييد القراءة/الكتابة حسب الدور والمزرعة.
- عدم تسجيل أو عرض مفاتيح حساسة في الواجهة.

## 11) النشر والبنية التحتية

- Vite للبناء المحلي.
- Netlify (netlify/functions/api.ts) لوظائف بدون خادم عند الحاجة.
- إعدادات Tailwind وPostCSS وtsconfig موجودة في الجذر.

## 12) أمثلة سيناريوهات عملية

1) إعداد تقرير شامل شهريًا لكل المزارع:
   - اختر "Toutes les fermes" + الفترة "specific_month".
   - اضغط "Rapport PDF" واختر التقرير المتقدم.
   - سيُنشأ PDF يحتوي جميع الأقسام، وصفحة للمشرفين، وصفحة للشركات.

2) تعيين مشرفين ومتابعة أدائ��م:
   - أضف مشرفًا جديدًا مع company وحالته "actif".
   - اربط العمال بـ supervisorId المناسب.
   - راقب جدول "Analyse des superviseurs" ونسبة مساهمة كل مشرف.

3) إدارة المساكن:
   - من "Rooms" تأكد من سعة الغرف.
   - انقل عاملًا إلى غرفة أخرى وتحقق من نسبة الإشغال في الإحصائيات.

4) تحويل عمال بين المزارع:
   - أنشئ تحويلًا من Transfers واختر العمال.
   - تابع حالات التحويل حتى "delivered".

5) المخزون:
   - أضف دفعة جديدة أو نفّذ تحويل مخزون.
   - استخدم التنبيهات لتتبّع مستوى العناصر.

## 13) أفضل الممارسات في الشفرة

- استخدام useMemo/useEffect بشكل مدروس لتحسين الأداء.
- حسابات الإحصاءات تعتمد على التصفية الحالية فقط (نفس البنية للكل/مزرعة واحدة).
- تقسيم الجداول الضخمة إلى صفحات، وتجنب العمليات الثقيلة داخل render دون memoization.
- التعامل مع حالات الخطأ والتراجع إلى PDF أساسي عند الحاجة.

## 14) ملاحظ��ت مهمة

- تم التأكد من وضع جدول "المشرفين" وجدول "الشركات (interime)" كلٌ في صفحة خاصة به داخل تقرير PDF.
- تم إصلاح مشكلات ترميز الحروف (مثل "Capacité" و"Date d'entrée" و"DÉMOGRAPHIE").
- في حال ظهور جداول فارغة للمشرفين: تأكد من وجود عمال نشطين مرتبطين بـ supervisorId ومن أن المشرفين بحالة "actif".

---

بهذا تكون لديك صورة كاملة عن المشروع: صفحاته وميزاته وتدفّقات العمل وكيفية التصدير والمزامنة والإدارة. يمكن استخدام هذا المستند كمرجع تدريبي وتشغيلي وفني في آن واحد.
